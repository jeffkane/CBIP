---
title: "University of Washington Snag Treatment Data Estimation by Size Class"
author: "Micah Wright"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  pdf_document: default
  html_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "../..")
```

# Purpose

This document converts the snag treatment to size-class specific loading values based on the clearcut data set and saves a .csv file for later use.

# Setup

Load the necessary packages and functions.

```{r message=FALSE, warning=FALSE}
library(foreign)
library(data.table)
library(ggplot2)
```

# Load Data

```{r}
snags <- read.dbf("data/UW/batch_out/Treatment_Snags.dbf",
                  as.is = TRUE)

snags <- as.data.table(snags)

clearcut <- fread("data/UW/residue/Remove100Percent.csv")
```

Calculate the total load for all fuel size classes in the clearcut data. NOTE: Foliage is excluded.

```{r}
clearcut[, total_load := Stem_6t9_tonsAcre + Stem_4t6_tonsAcre + Stem_ge9_tonsAcre + Branch_tonsAcre]
```

Calculate the proportion of total for each fuel size class.

```{r}
get_proportion <- function(x, y) {
        prop <- ifelse(y == 0, 0, x / y)
}

clearcut[, ':=' (Stem_6t9_prop = get_proportion(Stem_6t9_tonsAcre, total_load),
                 Stem_4t6_prop = get_proportion(Stem_4t6_tonsAcre, total_load),
                 Stem_ge9_prop = get_proportion(Stem_ge9_tonsAcre, total_load),
                 Branch_prop = get_proportion(Branch_tonsAcre, total_load))]

props <- clearcut[, .(FCID2018, 
                            Stem_6t9_prop, 
                            Stem_4t6_prop,
                            Stem_ge9_prop,
                            Branch_prop)]
```

Merge the data.

```{r}
snags[, FCID2018 := Value]
snags <- merge(snags,
               props,
               by = "FCID2018")
```

Partition the snag load using the proportions calculated earlier. Include a foliage column, with 0 for all rows. This assumes foliage is lost.

```{r}
snags[, ':=' (Stem_6t9_tonsAcre = (Stem_6t9_prop * SnagB) / 2000,
              Stem_4t6_tonsAcre = (Stem_4t6_prop * SnagB) / 2000,
              Stem_ge9_tonsAcre = (Stem_ge9_prop * SnagB) / 2000,
              Branch_tonsAcre = (Branch_prop * SnagB) / 2000,
              Foliage_tonsAcre = 0.0)]
```

Trim and save the output.

```{r}
output <- snags[, .(FCID2018 = FCID2018,
                    TPA = SnagTPA,
                    Stem_6t9_tonsAcre = Stem_6t9_tonsAcre,
                    Stem_4t6_tonsAcre = Stem_4t6_tonsAcre,
                    Stem_ge9_tonsAcre = Stem_ge9_tonsAcre,
                    Branch_tonsAcre = Branch_tonsAcre,
                    Foliage_tonsAcre = Foliage_tonsAcre)]

fwrite(output, "data/UW/residue/Snags.csv")
```

Inspect some plots.

```{r}
output_melted <- melt(output[, .(FCID2018,
                                 Stem_6t9_tonsAcre,
                                 Stem_4t6_tonsAcre,
                                 Stem_ge9_tonsAcre,
                                 Branch_tonsAcre)], 
                      id.vars = c("FCID2018"),
                      measure.vars = c("Stem_6t9_tonsAcre",
                                       "Stem_4t6_tonsAcre",
                                       "Stem_ge9_tonsAcre",
                                       "Branch_tonsAcre"),
                      variable.name = "size_class", 
                      value.name = "load",
                      variable.factor = FALSE)

output_melted[, data_set := "Snags"]

clearcut_melted <- melt(clearcut[, .(FCID2018,
                                 Stem_6t9_tonsAcre,
                                 Stem_4t6_tonsAcre,
                                 Stem_ge9_tonsAcre,
                                 Branch_tonsAcre)], 
                      id.vars = c("FCID2018"),
                      measure.vars = c("Stem_6t9_tonsAcre",
                                       "Stem_4t6_tonsAcre",
                                       "Stem_ge9_tonsAcre",
                                       "Branch_tonsAcre"),
                      variable.name = "size_class", 
                      value.name = "load",
                      variable.factor = FALSE)

clearcut_melted[, data_set := "Clearcut"]

all_melted <- merge(clearcut_melted, 
                    output_melted, 
                    by = c("FCID2018", "size_class"),
                    suffix = c("_clearcut", "_snags"))

ggplot(all_melted, aes(load_clearcut, load_snags)) +
        geom_point(alpha = 0.5) +
        geom_abline(slope = 1, intercept = 0, color = "red") +
        facet_wrap(~ size_class, scales = "free")
```

