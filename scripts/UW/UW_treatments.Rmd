---
title: "University of Washington Treatment Data Aggregation and Inspection"
author: "Micah Wright"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  pdf_document: default
  html_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "../..")
```

# Purpose

This document combines the attribute tables from the UW treatment rasters, calculates residual biomass for harvest breakage and pulp logs, and saves the result before performing a brief summary analysis.

# Setup

Load the necessary packages and functions.

```{r message=FALSE, warning=FALSE}
source("scripts/Other/break_residue.R")

library(parallel)
```

# Load Data

Load treatment raster attribute tables. I exported these as .dbf files from within Arc, so no script exists. The column names were truncated during the export process, so they don't match the documentation exactly, but the column order is the same. Currently, the break_residue function assumes that harvest breakage is a function of harvest type and harvest system, and that bark is attached to the stems by size class. The remaining percentage from the smaller (4-9") columns is placed in seperate columns as pulp log biomass. Units are lbs/acre from US, so the script also converts the units to tons/acre to match FCCS. 

```{r}
treatment_combos <- fread("data/SERC/scenarios.csv", verbose = FALSE)

treatment_combos[, Silvicultural_Treatment := gsub(" ", "_", Silvicultural_Treatment)]

treatment_combos[, Silvicultural_Treatment := gsub("[%]", "", Silvicultural_Treatment)]

# TODO: remove the next two commands when (if) updated snag data is obtained
setkey(treatment_combos, Silvicultural_Treatment)

treatment_combos <- treatment_combos[!"Standing_Dead"]

treatment_combos[, Harvest_Type := gsub(" ", "_", Harvest_Type)]

noaction <- data.table(ID = c(249L, 250L),
                       Silvicultural_Treatment = c("No_Action", "No_Action"),
                       Harvest_System = c("None", "None"),
                       Harvest_Type = c("None", "None"),
                       Burn_Type = c("None", "Broadcast Burn"),
                       Biomass_Collection = c("None", "None"))

treatment_combos <- rbind(treatment_combos, noaction)

Residue_list <- mclapply(seq(1:nrow(treatment_combos)),
                         mc.cores = detectCores() - 1,
                         function(i) {
                                 break_residue(treatment = treatment_combos[i, Silvicultural_Treatment],
                                               harvest_type = treatment_combos[i, Harvest_Type], 
                                               harvest_system = treatment_combos[i, Harvest_System])
                         })

Residue_by_treat <- rbindlist(Residue_list)

fwrite(Residue_by_treat, "data/UW/Residue_by_treat.csv")
```
