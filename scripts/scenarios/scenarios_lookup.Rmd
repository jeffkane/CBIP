---
title: "SERC biomass scenario analysis"
author: "Micah Wright"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  pdf_document: default
  html_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "../..")
```

# Purpose

This document loads the SERC scenario matrix and partitions it into lookup tables for later use.

# Setup

Load the necessary packages.

```{r message=FALSE}
library(readxl)
library(tidyverse)
```

# Extract Scenarios Lookup Table

Load the scenario matrix, and extract the different scenarios. Note that this excludes pulp market scenarios.

```{r message=FALSE}
scenarios <- read_xlsx("data/SERC/Scenario_Matrix_v6.xlsx",
                       col_names = FALSE, 
                       range = "A1:G478")

scenarios_names <- as.character(scenarios[2,])

scenarios_names <- str_replace_all(scenarios_names, " ", "_")

scenarios <- scenarios[c(-1, -2), ]

names(scenarios) <- scenarios_names

scenarios<- scenarios %>%
        mutate(Silvicultural_Treatment = gsub(" ", "_", 
                                              Silvicultural_Treatment),
               ID = as.integer(ID),
               Harvest_Type = gsub(" ", "_", Harvest_Type),
               Burn_Type = gsub(" Burn", "", Burn_Type)) %>%
        mutate(Silvicultural_Treatment = gsub("[%]", "", Silvicultural_Treatment))

noaction <- data.frame(ID = (max(scenarios$ID) + 1):(max(scenarios$ID) + 2),
                       Silvicultural_Treatment = rep("No_Action", 2),
                       Harvest_System = rep("None", 2),
                       Harvest_Type = rep("None", 2),
                       Burn_Type = c("None", "Broadcast"),
                       Biomass_Collection = rep("None", 2),
                       Pulp_Market = rep("No", 2),
                       stringsAsFactors = FALSE)

scenarios <- bind_rows(scenarios, noaction)

write_csv(scenarios, "data/SERC/scenarios.csv")
```

# Extract Biomass Fate Lookup Tables

Creat a helper function that saves the scenario-specific biomass fate lookup tables after some minor munging to correct column names, etc.

```{r}
get_sections <- function(fraction_type, range) {
        
        section <- read_xlsx("data/SERC/Scenario_Matrix_v6.xlsx",
                             col_names = FALSE, 
                             range = range)
        
        section_names <- as.character(section[2,])
        
        section <- section[c(-1, -2), ]
        
        names(section) <- section_names
        
        section <- section %>%
                transmute(Type = fraction_type,
                          Stem_ge9 = `Stem 9+`,
                          Stem_6t9 = `Stem 6-9`,
                          Stem_4t6 = `Stem 4-6`,
                          Branch = Branch,
                          Foliage = Foliage) %>%
                add_row(Type = fraction_type,
                        Stem_ge9 = rep(0.0, 2),
                        Stem_6t9 = rep(0.0, 2),
                        Stem_4t6 = rep(0.0, 2),
                        Branch = rep(0.0, 2),
                        Foliage = rep(0.0, 2))
        
        section <- bind_cols(scenarios, section)

        write_csv(section, paste0("data/SERC/lookup_tables/", fraction_type, ".csv"))

}
```

Create lists for fraction type and cell range.

```{r}
type_list = list("recovered_by_size",
                 "harvested_biomass",
                 "piled_at_landing",
                 "piled_in_field",
                 "scattered_in_field")

range_list = list("L1:V478",
                  "W1:AG478",
                  "AH1:AR478",
                  "AS1:BC478",
                  "BD1:BN478")
```

Iterate the function over the two lists.

```{r results=FALSE, message=FALSE}
map2(type_list, range_list, function(x, y) get_sections(x, y)) 
```

